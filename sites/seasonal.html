<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Seasonal Planting Calendar (UK) â€” Patch & Pot</title>
<meta name="description" content="Small-space sowing, planting & harvesting with regional variants for Scotland, Ireland, England and Wales.">
<style>
  :root{
    --bg:#0b0f14; --ink:#fff; --ink-d:#cfd3d8; --glass:#0f131a; --stroke:#1f2630;
    --maxw:1100px; --r:14px;
    --header-logo-h: 50px;   /* header pot size */
    --footer-logo-w: 65px;   /* footer pot size */
  }
  html,body{background:var(--bg);color:var(--ink);margin:0;font:16px/1.45 Inter,system-ui,Segoe UI,Arial,sans-serif}

  /* Header */
  .pp-header{position:sticky;top:0;z-index:2000;background:#0b0f14;border-bottom:1px solid var(--stroke)}
  .pp-header__inner{max-width:var(--maxw);margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:10px}
  .pp-header__brand{display:flex;align-items:center;text-decoration:none;gap:10px}
  .pp-header__logo{height:var(--header-logo-h);width:auto;display:block}
  .pp-header__brand span{font-weight:600;font-size:1.2rem;color:#fff}
  .pp-header__nav{display:none;gap:16px;margin-left:auto}
  .pp-nav__link{color:#cfd3d8;text-decoration:none;padding:6px 4px}
  .pp-nav__link:hover{color:#fff}
  .pp-header__burger{margin-left:auto;background:transparent;border:0;width:40px;height:40px;
    display:inline-flex;flex-direction:column;justify-content:center;align-items:center;gap:5px;cursor:pointer}
  .pp-burger-bar{width:22px;height:2px;background:#e6e6ea;display:block}
  @media(min-width:900px){.pp-header__nav{display:flex}.pp-header__burger{display:none}}
  .pp-header--open .pp-header__nav{display:flex;flex-direction:column;position:absolute;left:0;right:0;top:100%;
    background:#0b0f14;border-bottom:1px solid var(--stroke);padding:10px 16px;gap:10px}

  /* Page */
  .wrap{max-width:var(--maxw);margin:0 auto;padding:18px 20px}
  h1{margin:.4rem 0 .7rem;font-size:2.2rem}
  .lead{color:var(--ink-d)}
  .bar{background:var(--glass);border:1px solid var(--stroke);border-radius:var(--r);padding:12px;
    display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:12px 0}
  .control{display:flex;align-items:center;gap:8px}
  select,input[type="text"]{background:var(--glass);color:var(--ink);border:1px solid var(--stroke);border-radius:10px;padding:8px 10px}
  .muted{color:var(--ink-d)}
  .section{background:var(--glass);border:1px solid var(--stroke);border-radius:var(--r);padding:14px;margin:12px 0}
  .legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--stroke);border-radius:999px;padding:4px 8px}
  .pill .emoji{font-size:1rem}

  /* Table */
  .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:6px}
  table{border-collapse:collapse}
  thead th{position:sticky;top:0;background:#0f141b}
  th,td{border:1px solid var(--stroke);padding:10px;text-align:center;vertical-align:top;line-height:1.35}
  @media (orientation:portrait){
    table{min-width:920px}
    th:first-child, td:first-child{ text-align:left; min-width:180px; max-width:220px; word-break:break-word }
    tbody tr{min-height:64px}
  }
  @media (orientation:landscape){
    table{width:100%;table-layout:fixed}
    th:first-child, td:first-child{ text-align:left; width:32%; word-break:break-word }
    th:not(:first-child), td:not(:first-child){ width:calc(68% / 12) }
    tbody tr{min-height:60px}
  }

  /* Footer */
  .site-footer{background:#0b0f14;padding:24px 18px;text-align:center;border-top:1px solid var(--stroke)}
  .site-footer__logo{width:var(--footer-logo-w);height:auto;display:block;margin:0 auto 10px}
  .site-footer p{margin:0;font-size:.9rem;color:#ccc}
  .site-footer p + p{margin-top:4px}

  /* Diagnostics (hidden unless ?debug=1) */
  #diag{display:none;margin:10px 0}
  #diag pre{white-space:pre-wrap;background:#0f141b;border:1px solid #233046;border-radius:10px;padding:10px;color:#cfe1ff;max-height:280px;overflow:auto}
  #diag.active{display:block}
</style>
</head>
<body>

<header id="ppHeader" class="pp-header" role="banner">
  <div class="pp-header__inner">
    <a class="pp-header__brand" href="/">
      <img src="img/patchandpot-logo.png" alt="Patch & Pot" class="pp-header__logo">
      <span>Patch &amp; Pot</span>
    </a>
    <button class="pp-header__burger" id="ppBurger" aria-label="Menu" aria-expanded="false" aria-controls="ppNav">
      <span class="pp-burger-bar"></span><span class="pp-burger-bar"></span><span class="pp-burger-bar"></span>
    </button>
    <nav class="pp-header__nav" id="ppNav" aria-label="Primary">
      <a href="/" class="pp-nav__link">Home</a>
      <a href="/growing" class="pp-nav__link">Growing</a>
      <a href="/seasonal" class="pp-nav__link">Seasonal</a>
      <a href="/recipes" class="pp-nav__link">Recipes</a>
      <a href="/wellbeing" class="pp-nav__link">Wellbeing</a>
      <a href="/exercise" class="pp-nav__link">Exercise</a>
      <a href="/guides" class="pp-nav__link">Guides</a>
      <a href="/ideas" class="pp-nav__link">Ideas</a>
      <a href="/contact" class="pp-nav__link">Contact</a>
    </nav>
  </div>
</header>

<div class="wrap">
  <h1>Seasonal Planting Calendar (UK)</h1>
  <p class="lead">Small-space sowing, planting &amp; harvesting with regional variants for <strong>Scotland</strong>, <strong>Ireland</strong>, <strong>England</strong> and <strong>Wales</strong>.</p>

  <div class="bar">
    <div class="control">
      <label for="regionSel" class="muted">Region:</label>
      <select id="regionSel">
        <option value="scotland">Scotland</option>
        <option value="ireland">Ireland</option>
        <option value="england">England</option>
        <option value="wales">Wales</option>
      </select>
    </div>
    <div class="control" style="flex:1 1 220px">
      <input id="searchBox" type="text" placeholder="Search crops (e.g., carrot, lettuce)">
    </div>
    <div class="control">
      <select id="catSel">
        <option value="all">All categories</option>
        <option value="alliums">Alliums</option>
        <option value="fruit">Fruit</option>
        <option value="herbs">Herbs</option>
        <option value="leafy">Leafy</option>
        <option value="legumes">Legumes</option>
        <option value="other">Other</option>
        <option value="roots">Roots</option>
        <option value="softfruit">Soft fruit</option>
      </select>
    </div>
    <div class="control">
      <input id="monthOnly" type="checkbox"><label for="monthOnly" class="muted">Show activity this month only</label>
    </div>
    <span id="status" class="muted" aria-live="polite"></span>
  </div>

  <!-- DEBUG (hidden unless ?debug=1 or 'd'+'b' keys) -->
  <details id="diag"><summary>Diagnostics</summary><pre id="diagPre"></pre></details>

  <!-- Basics -->
  <div class="section" id="basicsBox" hidden>
    <h3 style="margin:.2rem 0 .6rem">Basics</h3>
    <div id="basicSoil"></div>
    <div id="basicTools"></div>
    <div id="basicNotes"></div>
  </div>

  <!-- Pest Watch -->
  <div class="section" id="pestBox" hidden>
    <div id="pestTitle" style="font-weight:700;margin-bottom:.4rem"></div>
    <ul id="pestList" style="margin:.2rem 0 .2rem 1.2rem"></ul>
  </div>

  <!-- Legend -->
  <div class="section">
    <div class="legend">
      <span class="pill"><span class="emoji">ðŸŒ±</span> Sow</span>
      <span class="pill"><span class="emoji">ðŸŒ¿</span> Plant</span>
      <span class="pill"><span class="emoji">ðŸ§º</span> Harvest</span>
    </div>
  </div>

  <!-- Table -->
  <div class="section table-wrap">
    <table aria-label="Seasonal calendar">
      <thead>
        <tr>
          <th>Crop</th>
          <th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th><th>May</th><th>Jun</th>
          <th>Jul</th><th>Aug</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dec</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div id="emptyMsg" class="muted" style="display:none;margin-top:6px">No crops found.</div>
  </div>
</div>

<footer class="site-footer">
  <img class="site-footer__logo" src="img/patchandpot-logo.png" alt="Patch & Pot">
  <p>Â© 2025 Patch & Pot</p>
  <p>Created by Grant Cameron Anthony</p>
</footer>

<script>
/* Header burger */
(function(){const root=document.getElementById('ppHeader');if(!root)return;
const btn=root.querySelector('#ppBurger');const nav=root.querySelector('#ppNav');
btn.addEventListener('click',()=>{const open=root.classList.toggle('pp-header--open');btn.setAttribute('aria-expanded',open?'true':'false');});
nav.addEventListener('click',e=>{if(e.target.closest('a')){root.classList.remove('pp-header--open');btn.setAttribute('aria-expanded','false');}});})();

/* Seasonal loader with multi-path + diagnostics + pest/basics fixes */
(function(){
  const MONTHS=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const EMO={sow:"ðŸŒ±",plant:"ðŸŒ¿",harvest:"ðŸ§º"};
  const els={region:regionSel,cat:catSel,search:searchBox,monthOnly:monthOnly,status:status,tbody:tbody,
    emptyMsg:emptyMsg,basicsBox:basicsBox,basicSoil:basicSoil,basicTools:basicTools,basicNotes:basicNotes,
    pestBox:pestBox,pestTitle:pestTitle,pestList:pestList,diag:diag,diagPre:diagPre};

  const BLOCKS=['alliums','fruit','herbs','leafy','legumes','other','roots','softfruit'];
  const ALIAS={softfruit:['softfruit','soft-fruit']};

  const urlParams=new URLSearchParams(location.search);
  const debugOn=urlParams.get('debug')==='1';
  if(debugOn) els.diag.classList.add('active');
  (function(){let seq='';window.addEventListener('keydown',e=>{seq+=e.key.toLowerCase();seq=seq.slice(-2);if(seq==='db'){els.diag.classList.toggle('active');}});})();

  function bust(u){return `${u}${u.includes('?')?'&':'?'}v=${Date.now()}`;}
  async function fetchJSON(u){try{const r=await fetch(bust(u),{cache:'no-store'});if(!r.ok)throw 0;return await r.json();}catch(_){return null;}}
  function logDiag(line){ if(!els.diagPre) return; els.diagPre.textContent += line + "\n"; }

  function buildCandidates(region,file){
    return [
      `/data/regions/${region}/${file}`,
      `data/regions/${region}/${file}`,
      `./data/regions/${region}/${file}`,
      `/sites/data/regions/${region}/${file}`
    ];
  }

  async function fetchFirstOk(paths, note){
    for(const url of paths){
      try{
        const r=await fetch(bust(url),{cache:'no-store'});
        if(r.ok){ const j=await r.json(); logDiag(`OK   ${note}: ${url}`); return {data:j,url}; }
        logDiag(`FAIL ${note}: ${url} [${r.status}]`);
      }catch(err){ logDiag(`ERR  ${note}: ${url} [${err}]`); }
    }
    return {data:null,url:null};
  }

  async function loadRegion(region){
    els.diagPre.textContent=''; logDiag(`Region = ${region}`);

    const basicsP = fetchFirstOk(buildCandidates(region,'basics.json'),'basics.json');
    const pestP   = fetchFirstOk(buildCandidates(region,'pestwatch.json'),'pestwatch.json');

    const blockPromises = BLOCKS.map(async (block)=>{
      const names = (ALIAS[block]||[block]).map(n=>`${n}.json`);
      for(const fname of names){
        const res = await fetchFirstOk(buildCandidates(region,fname), `${block} (${fname})`);
        if(res.data){
          const arr = Array.isArray(res.data) ? res.data
                    : Array.isArray(res.data?.crops) ? res.data.crops
                    : null;
          if(arr) return arr.map(c=>({...(c||{}), _block:block, category:(c&&c.category)||block}));
        }
      }
      return [];
    });

    const [basicsRes, pestRes, ...blocks] = await Promise.all([basicsP, pestP, ...blockPromises]);

    // Pest can be {pestwatch:{...}} or just {...}
    const pest = (pestRes.data && (pestRes.data.pestwatch || pestRes.data)) || {};
    const basics = basicsRes.data || {};
    const crops  = blocks.flat().filter(x=>x && x.name);

    logDiag(`Loaded crops: ${crops.length} total`);
    return { basics, pest, crops, region };
  }

  function renderBasics(b){
    if (b.soil || b.tools || b.notes) {
      els.basicSoil.textContent  = b.soil  ? `Soil/Compost: ${b.soil}` : '';
      els.basicTools.textContent = b.tools ? `Tools: ${b.tools}`       : '';
      els.basicNotes.textContent = b.notes ? `Notes: ${b.notes}`       : '';
      els.basicsBox.hidden = false; return;
    }
    const lines = [];
    if (b.containers_vs_ground?.pots)        lines.push(`Pots: ${b.containers_vs_ground.pots}`);
    if (b.containers_vs_ground?.grow_bags)   lines.push(`Grow bags: ${b.containers_vs_ground.grow_bags}`);
    if (b.containers_vs_ground?.raised_beds) lines.push(`Raised beds: ${b.containers_vs_ground.raised_beds}`);
    if (b.watering_and_feeding?.watering_basics) lines.push(`Watering: ${b.watering_and_feeding.watering_basics}`);
    if (b.watering_and_feeding?.feeds)           lines.push(`Feeding: ${b.watering_and_feeding.feeds}`);
    if (b.protection_and_structures?.insect_mesh) lines.push(`Insect mesh: ${b.protection_and_structures.insect_mesh}`);
    if (b.protection_and_structures?.netting_bird) lines.push(`Bird netting: ${b.protection_and_structures.netting_bird}`);
    if (b.frost_and_wind?.last_frost_window)   lines.push(`Last frost window: ${b.frost_and_wind.last_frost_window}`);

    if (lines.length){
      els.basicSoil.textContent  = `Basics:`;
      els.basicTools.textContent = 'â€¢ ' + lines.slice(0, 3).join('\nâ€¢ ');
      els.basicNotes.textContent = lines.slice(3, 7).length ? ('â€¢ ' + lines.slice(3, 7).join('\nâ€¢ ')) : '';
      els.basicsBox.hidden = false;
    } else {
      els.basicsBox.hidden = true;
    }
  }

  function renderPest(region,pest){
    if(!pest || typeof pest!=='object'){ els.pestBox.hidden=true; return; }
    const m = String((new Date()).getMonth());
    const entry = pest[m] || {};
    const items = Array.isArray(entry.items) ? entry.items
                : Array.isArray(entry) ? entry
                : (typeof entry === 'string' ? [entry] : []);
    const titleText = entry.title || `Pest Watch â€” ${MONTHS[+m]} (${region[0].toUpperCase()+region.slice(1)})`;
    els.pestTitle.textContent = titleText;
    els.pestList.innerHTML = '';
    if(!items.length){
      const li=document.createElement('li'); li.textContent='No major alerts this month.'; els.pestList.appendChild(li);
    }else{
      items.forEach(t=>{const li=document.createElement('li'); li.textContent=t; els.pestList.appendChild(li);});
    }
    els.pestBox.hidden=false;
  }

  function filterCrops(crops){
    const q=(els.search.value||'').toLowerCase().trim();
    const cat=(els.cat.value||'all').toLowerCase();
    const mOnly=els.monthOnly.checked;
    const m=(new Date()).getMonth();
    return (crops||[]).filter(c=>{
      if(q && !c.name?.toLowerCase().includes(q)) return false;
      if(cat!=='all'){
        const cc=(c.category||'').toLowerCase();
        const bb=(c._block||'').toLowerCase();
        if(cc!==cat && bb!==cat) return false;
      }
      if(mOnly){
        const s=(c.months?.sow||[]).includes(m);
        const p=(c.months?.plant||[]).includes(m);
        const h=(c.months?.harvest||[]).includes(m);
        if(!(s||p||h)) return false;
      }
      return true;
    });
  }

  function cellMarks(c,m){
    const out=[]; if((c.months?.sow||[]).includes(m)) out.push(EMO.sow);
    if((c.months?.plant||[]).includes(m)) out.push(EMO.plant);
    if((c.months?.harvest||[]).includes(m)) out.push(EMO.harvest);
    return out.join(' ');
  }

  function renderTable(crops, region){
    const list=filterCrops(crops||[]);
    els.status.textContent=`${region[0].toUpperCase()+region.slice(1)} â€” ${list.length} crops shown`;
    const frag=document.createDocumentFragment();
    list.forEach(c=>{
      const tr=document.createElement('tr');
      const name=document.createElement('td'); name.textContent=c.name||''; tr.appendChild(name);
      for(let i=0;i<12;i++){ const td=document.createElement('td'); const marks=cellMarks(c,i); if(marks) td.textContent=marks; tr.appendChild(td); }
      frag.appendChild(tr);
    });
    els.tbody.innerHTML=''; els.tbody.appendChild(frag);
    els.emptyMsg.style.display = list.length ? 'none' : 'block';
  }

  let cache={region:null,data:null};
  async function refresh(){
    const region=(els.region.value||'scotland').toLowerCase();
    if(!cache.data || cache.region!==region){
      els.status.textContent='Loadingâ€¦';
      cache.data = await loadRegion(region);
      cache.region = region;
      renderBasics(cache.data.basics);
      renderPest(region, cache.data.pest);
    }
    renderTable(cache.data.crops, region);
  }

  els.region.addEventListener('change',refresh);
  els.cat.addEventListener('change',refresh);
  els.monthOnly.addEventListener('change',refresh);
  let t=null; els.search.addEventListener('input',()=>{clearTimeout(t); t=setTimeout(refresh,150);});

  refresh();
})();
</script>
</body>
</html>
