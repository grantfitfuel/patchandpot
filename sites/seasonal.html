<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Seasonal Planting Calendar â€¢ Patch &amp; Pot (UK)</title>
  <meta name="description" content="UK seasonal planting calendar for small spaces with Scotland, Ireland, England and Wales variants: what to sow, plant and harvest, plus pest watch.">

  <!-- Sitewide CSS -->
  <link rel="stylesheet" href="style.css?v=51">

  <style>
    .pp-sub { color: var(--muted, #a6b6af); margin: 0 0 .8rem }
    .pp-card { background: var(--panel, #161c19); border:1px solid var(--stroke, #2b332f); border-radius:16px; padding:1rem; margin:1rem 0 }
    .pp-toolbar { display:flex; flex-wrap:wrap; gap:.6rem 1rem; align-items:center; padding:.6rem .8rem; background:rgba(255,255,255,.04); border:1px solid var(--stroke, #2b332f); border-radius:12px }
    .pp-select, .pp-search { background:#0c100e; color:var(--ink,#e6f0ea); border:1px solid var(--stroke,#2b332f); border-radius:10px; padding:.5rem .65rem }
    .pp-help { color: var(--muted,#a6b6af); margin:.5rem 0 0 }
    .pp-filters { display:grid; gap:.6rem 1rem; grid-template-columns: 1fr auto; align-items:center }
    .pp-filters .left { display:flex; gap:.6rem; flex-wrap:wrap; align-items:center }
    .pp-filters .right { display:flex; gap:.6rem; align-items:center }

    .pp-pestwatch { background: var(--panel-2, #1b221f); border-left:4px solid var(--green,#35c26a); border-radius:14px; padding:1rem; margin:1rem 0; border:1px solid var(--stroke,#2b332f) }
    .pp-pestwatch ul { margin:.4rem 0 0; padding-left:1.1rem }
    .pp-month-hint { color: var(--muted,#a6b6af); margin:.2rem 0 .6rem }
    .pp-list { list-style:none; padding:0; margin:0 }
    .pp-list li { padding:.55rem .65rem; border:1px dashed var(--stroke,#2b332f); border-radius:10px; margin:.4rem 0; background:#0f1512 }

    /* Calendar grid */
    .pp-calendar {
      display:grid;
      grid-template-columns: 220px repeat(12, 56px);
      gap:2px;
      border:1px solid var(--stroke,#2b332f);
      border-radius:16px;
      overflow:hidden;
      background:#0f1512;
    }
    .pp-row { display:contents }
    .pp-cell,.pp-head { padding:.55rem .6rem; border:1px solid var(--stroke,#2b332f); font-size:.95rem }
    .pp-head { font-weight:700; background:#121815 }
    .pp-crop { font-weight:700; background:#121815; }
    /* Wrap long names */
    .pp-crop, .pp-cell { white-space: normal; overflow-wrap:anywhere; }
    .pp-tags { display:inline-block; font-size:.8rem; color: var(--muted,#a6b6af); margin-left:.4rem }

    /* Key / Legend */
    .pp-card-key {
      background: var(--panel, #161c19);
      border: 1px solid var(--stroke, #2b332f);
      border-radius: 12px;
      padding: .6rem .9rem;
      margin: .8rem 0 1.2rem;
      font-size: .95rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1.2rem;
    }
    .pp-card-key div { display:flex; align-items:center; gap:.4rem }
    .pp-card-key span { font-size:1.2rem }

    /* Error panel */
    .pp-errors { display:none; background:#2b1515; border:1px solid #6d2b2b; color:#ffdddd; border-radius:12px; padding:10px 12px; margin:16px 0; }
    .pp-errors h3 { margin:.2rem 0 .4rem; font-size:1rem }
    .pp-errors ul { margin:.2rem 0 0 1rem }

    footer { border-top:1px solid #142116; margin-top:28px; background:#0a0f0c; text-align:center; padding:20px 0 }
    .footer-inner { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px }
    .footer-pot { width:36px; height:36px; object-fit:contain }

    /* Tablets */
    @media (max-width: 1024px){ .pp-calendar{ grid-template-columns: 200px repeat(12, 48px) } }
    /* iPad / small tablets */
    @media (max-width: 900px){
      .pp-calendar{ grid-template-columns: 200px repeat(12, 44px) }
      .pp-cell,.pp-head{ padding:.45rem }
      .pp-crop, .pp-cell { font-size:0.9rem; line-height:1.35 }
    }
    /* Phones */
    @media (max-width: 680px){
      .pp-filters{ grid-template-columns:1fr }
      .pp-calendar{ grid-template-columns: 1fr repeat(12, 32px) }
      .pp-cell,.pp-head{ padding:.4rem }
      .pp-crop, .pp-cell { font-size:0.85rem; line-height:1.3 }
    }
    /* Very small phones */
    @media (max-width: 420px){
      .pp-tags { display:none }
      .pp-calendar{ grid-template-columns: 1fr repeat(12, 30px) }
    }
  </style>
</head>
<body>

  <!-- Shared HEADER -->
  <div data-include="partials/header.html"></div>

  <main class="wrap" id="maincontent">
    <h1>Seasonal Planting Calendar (UK)</h1>
    <p class="pp-sub">Small-space sowing, planting &amp; harvesting with regional variants for <strong>Scotland</strong>, <strong>Ireland</strong>, <strong>England</strong> and <strong>Wales</strong>.</p>

    <!-- Filters -->
    <section class="pp-card">
      <div class="pp-toolbar pp-filters" role="group" aria-label="Region and filters">
        <div class="left">
          <label for="pp-region">Region:</label>
          <select id="pp-region" class="pp-select" aria-label="Choose your region">
            <option value="scotland">Scotland</option>
            <option value="ireland">Ireland</option>
            <option value="england">England</option>
            <option value="wales">Wales</option>
          </select>
          <input id="pp-search" class="pp-search" type="search" placeholder="Search crops (e.g., carrot, basil)â€¦" aria-label="Search crops by name">
          <label for="pp-category" class="sr-only">Category</label>
          <select id="pp-category" class="pp-select" aria-label="Filter by category">
            <option value="all">All categories</option>
            <option value="leafy">Leafy</option>
            <option value="roots">Roots</option>
            <option value="legumes">Legumes</option>
            <option value="fruit">Fruiting veg</option>
            <option value="alliums">Alliums</option>
            <option value="herbs">Herbs</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="right">
          <label><input type="checkbox" id="pp-this-month"> <span>Show activity this month only</span></label>
        </div>
      </div>
      <p class="pp-help">Tip: pick a <strong>Region</strong>, type to <strong>search</strong>, choose a <strong>Category</strong>, or toggle <strong>This month only</strong>.</p>
    </section>

    <!-- Pest watch -->
    <section class="pp-pestwatch" id="pp-pestwatch">
      <h3>Pest Watch â€“ <span id="pp-month-name"></span> (<span id="pp-region-name"></span>)</h3>
      <ul><li>Loadingâ€¦</li></ul>
    </section>

    <!-- Today -->
    <section class="pp-card">
      <h2>What Can I Plant Today?</h2>
      <p class="pp-month-hint" id="pp-month-hint"></p>
      <ul id="pp-today-list" class="pp-list"></ul>
    </section>

    <!-- Calendar -->
    <section>
      <h2>Seasonal Planting Calendar</h2>

      <!-- Key / Legend -->
      <div class="pp-card-key" aria-label="Calendar key">
        <div><span aria-hidden="true">ðŸŒ±</span><span>Sow seed</span></div>
        <div><span aria-hidden="true">ðŸª´</span><span>Plant out / transplant</span></div>
        <div><span aria-hidden="true">ðŸ¥•</span><span>Harvest</span></div>
      </div>

      <div class="pp-calendar" id="pp-calendar" role="table" aria-label="Seasonal planting calendar"></div>
    </section>

    <!-- Error box (shown only when something fails) -->
    <section id="pp-errors" class="pp-errors" aria-live="polite" aria-atomic="true">
      <h3>Data couldnâ€™t be loaded</h3>
      <p>Check these paths exist relative to <code>seasonal.html</code> and that the JSON is valid:</p>
      <ul id="pp-errors-list"></ul>
      <p class="pp-help">Expected structure: <code>data/regions/&lt;region&gt;/{basics,pestwatch,roots,leafy,legumes,fruit,alliums,herbs,softfruit,other}.json</code></p>
    </section>
  </main>

  <!-- FOOTER -->
  <footer>
    <div class="footer-inner">
      <img src="img/patchandpot-icon.png" alt="Patch &amp; Pot icon" class="footer-pot" onerror="this.style.display='none'">
      <p>Â© Patch &amp; Pot | <span class="credit">Created by Grant Cameron Anthony</span></p>
    </div>
  </footer>

  <!-- Header loader -->
  <script>
    (function loadHeader(){
      const holder=document.querySelector('[data-include="partials/header.html"]');
      if(!holder) return;
      fetch('partials/header.html',{cache:'no-store'})
        .then(r=>r.text()).then(html=>{
          holder.outerHTML=html;
          const header=document.getElementById('siteHeader'); if(!header) return;
          const toggle=header.querySelector('.menu-toggle');
          const nav=header.querySelector('#primaryNav');
          const path=(location.pathname.split('/').pop()||'index.html').toLowerCase();
          header.querySelectorAll('.nav a').forEach(a=>{
            if((a.getAttribute('href')||'').toLowerCase()===path) a.setAttribute('aria-current','page');
          });
          function setExpanded(on){
            if(!toggle) return;
            if(on){header.classList.add('menu-open');toggle.classList.add('menu-open');toggle.setAttribute('aria-expanded','true');}
            else{header.classList.remove('menu-open');toggle.classList.remove('menu-open');toggle.setAttribute('aria-expanded','false');}
          }
          if(toggle) toggle.addEventListener('click',()=>setExpanded(!header.classList.contains('menu-open')));
          if(nav) nav.addEventListener('click',e=>{if(e.target.tagName==='A') setExpanded(false);});
        })
        .catch(()=>{ /* keep quiet in case partial missing */ });
    })();
  </script>

  <!-- Seasonal logic -->
  <script>
    const PP_MONTHS=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const CUR_M=new Date().getMonth();
    let DATA={scotland:null,ireland:null,england:null,wales:null};
    const ERROR_PATHS=[];

    function inferCategory(n){
      n=(n||'').toLowerCase();
      if(/(lettuce|spinach|chard|rocket|kale|cabbage|salad|leaf)/.test(n))return'leafy';
      if(/(carrot|beet|radish|turnip|parsnip|root|swede|celeriac)/.test(n))return'roots';
      if(/(pea|bean|chickpea|lentil|soy|edamame)/.test(n))return'legumes';
      if(/(tomato|pepper|chilli|aubergine|courgette|cucumber|squash|pumpkin|melon|strawber|blueber|raspber|gooseber|currant|apple|pear|plum|cherry|rhubarb)/.test(n))return'fruit';
      if(/(onion|garlic|leek|shallot|spring onion|chive)/.test(n))return'alliums';
      if(/(parsley|coriander|basil|mint|thyme|sage|dill|oregano|marjoram|tarragon|chervil|fennel|lemon balm|bay)/.test(n))return'herbs';
      return'other';
    }

    function setMonthHints(){
      const m=PP_MONTHS[CUR_M];
      const hint=document.getElementById('pp-month-hint');
      const mEl=document.getElementById('pp-month-name');
      if(hint) hint.textContent=`Hereâ€™s what suits containers now in ${m}.`;
      if(mEl) mEl.textContent=m;
    }

    function renderPestWatch(rk){
      const region=DATA[rk]||{};
      const entry=(region.pestwatch&&region.pestwatch[String(CUR_M)])||{items:["No major alerts this month."]};
      const rn=document.getElementById('pp-region-name'); if(rn) rn.textContent=rk[0].toUpperCase()+rk.slice(1);
      const ul=document.querySelector('#pp-pestwatch ul'); if(ul) ul.innerHTML=(entry.items||[]).map(i=>`<li>${i}</li>`).join('')||'<li>No items.</li>';
    }

    function getFilters(){
      return{
        q:(document.getElementById('pp-search')?.value||'').trim().toLowerCase(),
        cat:document.getElementById('pp-category')?.value||'all',
        thisMonth:!!document.getElementById('pp-this-month')?.checked
      };
    }

    function applyFilters(list){
      const f=getFilters();
      return(list||[]).filter(c=>{
        const name=c.name||''; const cat=c.category||inferCategory(name);
        if(f.q&&!name.toLowerCase().includes(f.q))return false;
        if(f.cat!=='all'&&cat!==f.cat)return false;
        if(f.thisMonth){
          const s=(c.months?.sow||[]).includes(CUR_M);
          const p=(c.months?.plant||[]).includes(CUR_M);
          const h=(c.months?.harvest||[]).includes(CUR_M);
          if(!(s||p||h))return false;
        }
        return true;
      });
    }

    function renderToday(rk){
      const region=DATA[rk]||{};
      const list=document.getElementById('pp-today-list'); if(!list) return;
      const items=[];
      applyFilters(region.crops||[]).forEach(c=>{
        const s=(c.months?.sow||[]).includes(CUR_M);
        const p=(c.months?.plant||[]).includes(CUR_M);
        const h=(c.months?.harvest||[]).includes(CUR_M);
        if(s||p||h){
          const tag=c.category||inferCategory(c.name);
          items.push(`<li><strong>${c.name}</strong> ${s?"ðŸŒ±":""}${p?" ðŸª´":""}${h?" ðŸ¥•":""} <span class="pp-tags">(${tag})</span></li>`);
        }
      });
      list.innerHTML=items.length?items.join(''):`<li>No items match your filters for ${PP_MONTHS[CUR_M]}.</li>`;
    }

    function renderCalendar(rk){
      const region=DATA[rk]||{};
      const root=document.getElementById('pp-calendar'); if(!root) return;
      const head=`<div class="pp-row"><div class="pp-head">Crop</div>${PP_MONTHS.map(m=>`<div class="pp-head">${m}</div>`).join('')}</div>`;
      const rows=applyFilters(region.crops||[]).map(c=>{
        const cat=c.category||inferCategory(c.name);
        const cells=PP_MONTHS.map((_,i)=>{
          const s=(c.months?.sow||[]).includes(i);
          const p=(c.months?.plant||[]).includes(i);
          const h=(c.months?.harvest||[]).includes(i);
          const marks=[s?"ðŸŒ±":"",p?"ðŸª´":"",h?"ðŸ¥•":""].join(" ").trim();
          const lbl=[s?"Sow":"",p?"Plant":"",h?"Harvest":""].filter(Boolean).join(", ");
          return `<div class="pp-cell" aria-label="${c.name} ${PP_MONTHS[i]} ${lbl}">${marks}</div>`;
        }).join('');
        return `<div class="pp-row"><div class="pp-cell pp-crop">${c.name} <span class="pp-tags">(${cat})</span></div>${cells}</div>`;
      }).join('');
      root.innerHTML=head+rows;
    }

    function renderAll(){
      const sel=document.getElementById('pp-region');
      const r=sel?sel.value:'scotland';
      localStorage.setItem('pp-region',r);
      setMonthHints(); renderPestWatch(r); renderToday(r); renderCalendar(r);
    }

    /* ---------------- Data loader with robust path fallbacks ---------------- */
    const REGIONS=["scotland","england","ireland","wales"];
    const BLOCKS=["basics","pestwatch","roots","leafy","legumes","fruit","alliums","herbs","softfruit","other"];

    function fetchFirstOk(urls){
      const next=i=>{
        if(i>=urls.length){ return Promise.reject(new Error('all paths failed')); }
        // cache buster to beat iOS caching
        const url = urls[i] + (urls[i].includes('?') ? '' : `?v=${Date.now()}`);
        return fetch(url, {cache:'no-store'})
          .then(r=> r.ok ? r.json() : Promise.reject(new Error(String(r.status))))
          .catch(()=> next(i+1));
      };
      return next(0);
    }

    function candidatePaths(path){
      // Try: ./path, path, ../path, /path
      return [`./${path}`, path, `../${path}`, `/${path}`];
    }

    function loadRegionBlock(region, block){
      const blockPath = `data/regions/${region}/${block}.json`;
      const legacyPath = `data/crops-${region}.json`;
      // First try multi-block file
      return fetchFirstOk(candidatePaths(blockPath))
        .catch(()=>{
          // If block missing, fall back to legacy monolith and extract
          return fetchFirstOk(candidatePaths(legacyPath)).then(j=>{
            if(block==='basics' || block==='pestwatch') return j[block] || (block==='basics'?{}:{});
            const catMap={roots:'roots',leafy:'leafy',legumes:'legumes',fruit:'fruit',alliums:'alliums',herbs:'herbs',softfruit:'fruit',other:'other'};
            const want=catMap[block];
            const crops=Array.isArray(j.crops)?j.crops:[];
            return crops.filter(c => (c.category||'').toLowerCase().includes(want||''));
          });
        })
        .catch(()=>{
          ERROR_PATHS.push(blockPath);
          return block==='basics' ? {} : block==='pestwatch' ? {} : [];
        });
    }

    function assembleRegion(region){
      const meta = Promise.all([
        loadRegionBlock(region,'basics'),
        loadRegionBlock(region,'pestwatch')
      ]).then(([basics,pestwatch])=>({basics,pestwatch}));

      const crops = Promise.all(
        BLOCKS.filter(b=>b!=='basics' && b!=='pestwatch')
              .map(b => loadRegionBlock(region,b).then(arr=>Array.isArray(arr)?arr:[]))
      ).then(parts => parts.flat());

      return Promise.all([meta,crops]).then(([m,c])=>({
        region,
        basics: m.basics || {},
        pestwatch: m.pestwatch || {},
        crops: c || []
      }));
    }

    function showErrorsIfAny(){
      const box=document.getElementById('pp-errors');
      const list=document.getElementById('pp-errors-list');
      if(!box || !list) return;
      if(ERROR_PATHS.length){
        box.style.display='block';
        list.innerHTML = ERROR_PATHS.map(p=>`<li><code>${p}</code></li>`).join('');
      } else {
        box.style.display='none';
      }
    }

    Promise.all(REGIONS.map(r => assembleRegion(r).then(obj => (DATA[r]=obj))))
      .then(()=>{ showErrorsIfAny(); init(); })
      .catch(()=>{ showErrorsIfAny(); document.getElementById('pp-today-list').innerHTML='<li>Data failed to load.</li>'; });
  </script>
</body>
</html>
