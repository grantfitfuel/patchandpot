<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Seasonal Planting Calendar â€¢ Patch & Pot (UK)</title>
  <meta name="description" content="UK seasonal planting calendar for small spaces with Scotland, Ireland, England and Wales variants: what to sow, plant and harvest, plus pest watch.">
  <link rel="preload" href="img/patchandpot-icon.png" as="image">

  <!-- Base site stylesheet (keep yours); inline page locks below ensure readability -->
  <link rel="stylesheet" href="style.css">

  <!-- Page locks so text is readable and controls never sit off-screen -->
  <style>
    :root{
      --ink:#f5fff7; --muted:#c5d3c9; --panel:#121814; --panel2:#161e19;
      --line:#26302a; --accent:#2f8f4a; --accent-2:#7ed495;
    }
    html,body{background:#0c110e;color:var(--ink)}
    .wrap{max-width:1140px;margin:0 auto;padding:16px 20px}
    h1,h2,h3,strong{color:var(--ink)}
    .sub{color:var(--muted);margin:.35rem 0 1rem}

    /* Card + toolbar */
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:1rem;margin:1rem 0}
    .toolbar{display:grid;grid-template-columns:1fr auto;gap:12px 16px;align-items:center}
    .toolbar .left{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center}
    .toolbar .right{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;justify-content:flex-end}
    .sel,.search{background:#0b120e;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:.55rem .7rem}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:10px;padding:.62rem .95rem;font-weight:750;border:1px solid #2a4a38;background:var(--accent);color:#09130e;white-space:nowrap}
    .btn[disabled]{opacity:.7;cursor:wait}
    .help{color:var(--muted);margin:.5rem 0 0}

    /* Pest watch panel */
    .pest{background:var(--panel2);border:1px solid var(--line);border-left:4px solid var(--accent);border-radius:14px;padding:1rem;margin:1rem 0}
    .pest small{color:var(--muted)}
    .pest ul{margin:.4rem 0 0;padding-left:1.1rem}

    /* What can I plant today list */
    .list{list-style:none;margin:0;padding:0}
    .list li{background:#0f1512;border:1px dashed var(--line);border-radius:10px;margin:.4rem 0;padding:.55rem .65rem}

    /* Legend */
    .legend{display:flex;gap:18px;align-items:center;margin:.6rem 0 .6rem;color:var(--ink)}
    .legend span{display:inline-flex;gap:.35rem;align-items:center}

    /* Calendar grid (12 months incl. Dec) */
    .grid{
      display:grid;
      grid-template-columns:minmax(220px,1.2fr) repeat(12,minmax(52px,1fr));
      gap:2px;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:#0f1512;color:var(--ink)
    }
    .row{display:contents}
    .head,.cell{padding:.55rem .6rem;border:1px solid var(--line);font-size:.92rem;line-height:1.3;white-space:normal}
    .head{font-weight:800;background:#121815;text-align:center}
    .cell{text-align:center;font-size:1rem}
    .crop{background:#121815;font-weight:800;text-align:left}
    .tags{display:block;font-size:.82rem;color:var(--muted);font-weight:600;margin-top:.15rem}

    .note{color:var(--muted);margin:.5rem 0 1rem}

    .error{display:none;margin-top:10px;padding:.8rem 1rem;border-radius:12px;background:#3a2323;border:1px solid #6c2b2b;color:#ffd7d7}

    /* Footer â€“ pot centred, text under it (centred) */
    footer{border-top:1px solid #142116;margin-top:28px;background:#0a0f0c;text-align:center;padding:16px 0}
    .f-inner{display:flex;flex-direction:column;align-items:center;gap:6px}
    .pot{width:30px;height:30px;object-fit:contain}

    /* Keep toolbar controls on-screen on mobile */
    @media (max-width:900px){
      .toolbar{grid-template-columns:1fr}
      .toolbar .right{justify-content:flex-start}
      .grid{grid-template-columns:minmax(200px,1.2fr) repeat(12,minmax(44px,1fr))}
      .head,.cell{padding:.45rem}
    }
    @media (max-width:680px){
      .grid{grid-template-columns:minmax(188px,1.3fr) repeat(12,minmax(38px,1fr))}
      .head{font-size:.8rem}
      .cell{font-size:.95rem}
    }
  </style>
</head>
<body>
  <!-- Shared site header (kept) -->
  <div data-include="partials/header.html"></div>

  <main class="wrap" id="maincontent">
    <h1>Seasonal Planting Calendar (UK)</h1>
    <p class="sub">Small-space sowing, planting &amp; harvesting with regional variants for <strong>Scotland</strong>, <strong>Ireland</strong>, <strong>England</strong> and <strong>Wales</strong>.</p>

    <section class="card">
      <div class="toolbar" role="group" aria-label="Region and filters">
        <div class="left">
          <label for="pp-region">Region:</label>
          <select id="pp-region" class="sel" aria-label="Choose your region">
            <option value="scotland">Scotland</option>
            <option value="ireland">Ireland</option>
            <option value="england">England</option>
            <option value="wales">Wales</option>
          </select>

          <input id="pp-search" class="search" type="search" placeholder="Search crops (e.g., carrot, basil)â€¦" aria-label="Search crops by name">

          <label for="pp-category" class="sr-only" style="position:absolute;left:-9999px">Category</label>
          <select id="pp-category" class="sel" aria-label="Filter by category">
            <option value="all">All categories</option>
            <option value="leafy">Leafy</option>
            <option value="roots">Roots</option>
            <option value="legumes">Legumes</option>
            <option value="fruit">Fruiting veg</option>
            <option value="alliums">Alliums</option>
            <option value="herbs">Herbs</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="right">
          <button id="pp-make-pdf" class="btn" type="button" aria-label="Download seasonal calendar PDF">ðŸ“„ Download PDF</button>
          <label style="display:inline-flex;align-items:center;gap:.4rem">
            <input type="checkbox" id="pp-this-month"> <span>Show activity this month only</span>
          </label>
        </div>
      </div>
      <p class="help">Tip: pick a <strong>Region</strong>, type to <strong>search</strong>, choose a <strong>Category</strong>, or toggle <strong>This month only</strong> for a focused view.</p>
    </section>

    <section class="pest" id="pp-pestwatch" aria-labelledby="pestwatch-title">
      <h3 id="pestwatch-title">Pest Watch â€“ <span id="pp-month-name"></span> (<span id="pp-region-name"></span>)</h3>
      <small>Small spaces edition</small>
      <ul><li>Loadingâ€¦</li></ul>
    </section>

    <section class="card" aria-labelledby="today-title">
      <h2 id="today-title">What Can I Plant Today?</h2>
      <p id="pp-month-hint" class="sub"></p>
      <ul id="pp-today-list" class="list"></ul>
    </section>

    <div class="legend" aria-hidden="true">
      <span>ðŸŒ± <em>Sow</em></span>
      <span>ðŸª´ <em>Plant</em></span>
      <span>ðŸ¥• <em>Harvest</em></span>
    </div>
    <p class="note">On a narrow phone, rotate to landscape to see all months.</p>

    <section aria-labelledby="calendar-title">
      <h2 id="calendar-title">Seasonal Planting Calendar</h2>
      <div id="pp-calendar" class="grid" role="table" aria-label="Seasonal planting calendar"></div>
      <div id="pp-error" class="error"></div>
    </section>
  </main>

  <footer role="contentinfo">
    <div class="f-inner">
      <img src="img/patchandpot-icon.png" alt="Patch &amp; Pot icon" class="pot" onerror="this.style.display='none'">
      <p>Â© 2025 Patch &amp; Pot | Created by Grant Cameron Anthony</p>
    </div>
  </footer>

  <!-- Load header partial + nav current state -->
  <script>
    (function(){
      const holder=document.querySelector('[data-include="partials/header.html"]');
      if(!holder) return;
      fetch('partials/header.html',{cache:'no-store'})
        .then(r=>r.text()).then(html=>{
          holder.outerHTML=html;
          const header=document.getElementById('siteHeader'); if(!header) return;
          const toggle=header.querySelector('.menu-toggle');
          const nav=header.querySelector('#primaryNav');
          const fn=(location.pathname.split('/').pop()||'index.html').toLowerCase();
          header.querySelectorAll('.nav a').forEach(a=>{
            if((a.getAttribute('href')||'').toLowerCase()===fn){ a.setAttribute('aria-current','page'); }
          });
          function setOpen(on){
            header.classList.toggle('menu-open',on);
            if(toggle){ toggle.classList.toggle('menu-open',on); toggle.setAttribute('aria-expanded',on?'true':'false'); }
          }
          toggle && toggle.addEventListener('click', ()=>setOpen(!header.classList.contains('menu-open')));
          nav && nav.addEventListener('click', e=>{ if(e.target.tagName==='A') setOpen(false); });
        });
    })();
  </script>

  <!-- Seasonal logic (loads JSON, renders, exposes selection) -->
  <script>
    const MONTHS=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const CURM=(new Date()).getMonth();
    const REGIONS=["scotland","england","ireland","wales"];
    const BLOCKS=["basics","pestwatch","roots","leafy","legumes","fruit","alliums","herbs","softfruit","other"];
    let DATA={scotland:null,england:null,ireland:null,wales:null};
    const MISSING=Object.fromEntries(REGIONS.map(r=>[r,new Set()]));

    const H=(k)=>k? k[0].toUpperCase()+k.slice(1):"";

    function setMonthHints(){
      document.getElementById('pp-month-hint').textContent=`Hereâ€™s what suits containers now in ${MONTHS[CURM]}.`;
      document.getElementById('pp-month-name').textContent=MONTHS[CURM];
    }

    function inferCategory(name){
      const n=(name||"").toLowerCase();
      if(/(lettuce|spinach|chard|rocket|kale|cabbage|salad|leaf|mizuna|mustard|endive|radicchio|pak|choi|bok|tat\s*soi|watercress)/.test(n))return"leafy";
      if(/(carrot|beet|beetroot|radish|turnip|parsnip|root|swede|celeriac|salsify|scorzonera|fennel)/.test(n))return"roots";
      if(/(pea|bean|chickpea|lentil|soy|edamame)/.test(n))return"legumes";
      if(/(tomato|pepper|chilli|aubergine|eggplant|courgette|zucchini|cucumber|squash|pumpkin|melon|cucamelon|strawber|blueber|raspber|gooseber|currant|fig|apple|pear|plum|cherry|rhubarb|cape gooseberry|tomatillo)/.test(n))return"fruit";
      if(/(onion|garlic|leek|shallot|spring onion|elephant garlic|welsh onion|chive)/.test(n))return"alliums";
      if(/(parsley|coriander|cilantro|basil|mint|thyme|sage|dill|oregano|marjoram|tarragon|lovage|chervil|lemon balm|bay|stevia|rosemary)/.test(n))return"herbs";
      return"other";
    }

    function getFilters(){
      return{
        region: document.getElementById('pp-region')?.value || 'scotland',
        q:      (document.getElementById('pp-search')?.value||"").trim().toLowerCase(),
        cat:    document.getElementById('pp-category')?.value || "all",
        monthOnly: !!document.getElementById('pp-this-month')?.checked
      };
    }

    function applyFilters(list){
      const f=getFilters();
      return (list||[]).filter(c=>{
        if(!c || !c.name) return false;
        const name=c.name;
        const cat=(c.category||inferCategory(name));
        if(f.q && !name.toLowerCase().includes(f.q)) return false;
        if(f.cat!=="all" && cat!==f.cat) return false;
        if(f.monthOnly){
          const s=(c.months?.sow||[]).includes(CURM);
          const p=(c.months?.plant||[]).includes(CURM);
          const h=(c.months?.harvest||[]).includes(CURM);
          if(!(s||p||h)) return false;
        }
        return true;
      });
    }

    function renderPestWatch(regionKey){
      const region=DATA[regionKey] || {};
      const entry=(region.pestwatch && region.pestwatch[String(CURM)]) || { items:["No major alerts this month. Keep an eye on slugs after rain."] };
      document.getElementById('pp-region-name').textContent=H(regionKey);
      document.querySelector('#pp-pestwatch ul').innerHTML=(entry.items||[]).map(i=>`<li>${i}</li>`).join('') || '<li>No items.</li>';
    }

    function renderToday(regionKey){
      const region=DATA[regionKey] || {};
      const list=document.getElementById('pp-today-list');
      const items=[];
      applyFilters(region.crops||[]).forEach(c=>{
        const s=(c.months?.sow||[]).includes(CURM);
        const p=(c.months?.plant||[]).includes(CURM);
        const h=(c.months?.harvest||[]).includes(CURM);
        if(s||p||h){
          const tag=c.category||inferCategory(c.name);
          items.push(`<li><strong>${c.name}</strong> ${s?"ðŸŒ±":""}${p?" ðŸª´":""}${h?" ðŸ¥•":""} <span class="tags">(${tag})</span></li>`);
        }
      });
      list.innerHTML=items.length?items.join(''):`<li>No items match your filters for ${MONTHS[CURM]}.</li>`;
    }

    function renderCalendar(regionKey){
      const region=DATA[regionKey] || {};
      const wrap=document.getElementById('pp-calendar');
      const head=`<div class="row">
        <div class="head">Crop</div>
        ${MONTHS.map(m=>`<div class="head">${m}</div>`).join('')}
      </div>`;
      const rows=applyFilters(region.crops||[]).map(c=>{
        const cat=c.category||inferCategory(c.name);
        const cells=MONTHS.map((_,i)=>{
          const s=(c.months?.sow||[]).includes(i);
          const p=(c.months?.plant||[]).includes(i);
          const h=(c.months?.harvest||[]).includes(i);
          const marks=[s?"ðŸŒ±":"",p?"ðŸª´":"",h?"ðŸ¥•":""].filter(Boolean).join(" ");
          return `<div class="cell">${marks}</div>`;
        }).join('');
        return `<div class="row">
          <div class="crop"><span class="name">${c.name}</span><span class="tags">(${cat})</span></div>
          ${cells}
        </div>`;
      }).join('');
      wrap.innerHTML=head+rows;
    }

    function renderAll(){
      const {region}=getFilters();
      localStorage.setItem('pp-region',region);
      document.title=`Seasonal Planting (${H(region)}) â€¢ Patch & Pot`;
      setMonthHints(); renderPestWatch(region); renderToday(region); renderCalendar(region);
      const miss=[...MISSING[region]].sort();
      const box=document.getElementById('pp-error');
      if(miss.length){
        box.style.display='block';
        box.innerHTML=`<strong>Missing files for ${H(region)}:</strong><br>${miss.map(x=>`<code>data/regions/${region}/${x}.json</code>`).join('<br>')}`;
      }else{ box.style.display='none'; box.innerHTML=''; }
    }

    function fetchJSON(url){ return fetch(`${url}?v=${Date.now()}`,{cache:'no-store'}).then(r=> r.ok ? r.json() : Promise.reject(url)); }
    function loadBlock(region, block){
      const url=`data/regions/${region}/${block}.json`;
      return fetchJSON(url).catch(()=>{ MISSING[region].add(block); return (block==='basics'||block==='pestwatch')?{}:[]; });
    }
    function assembleRegion(region){
      const metaP=Promise.all([loadBlock(region,'basics'), loadBlock(region,'pestwatch')]).then(([basics,pestwatch])=>({basics,pestwatch}));
      const cropP=Promise.all(['roots','leafy','legumes','fruit','alliums','herbs','softfruit','other'].map(b=>loadBlock(region,b)))
        .then(parts=>parts.flat().filter(c=>c && c.name));
      return Promise.all([metaP,cropP]).then(([meta,crops])=>({region:H(region), basics:meta.basics||{}, pestwatch:meta.pestwatch||{}, crops}));
    }

    function boot(){
      const sel=document.getElementById('pp-region');
      if(sel) sel.value=localStorage.getItem('pp-region')||'scotland';
      ['pp-search','pp-category','pp-this-month'].forEach(id=>{
        const el=document.getElementById(id); el && el.addEventListener(id==='pp-search'?'input':'change',renderAll);
      });
      sel && sel.addEventListener('change',renderAll);
      renderAll();
    }
    Promise.all(REGIONS.map(r=>assembleRegion(r).then(o=>DATA[r]=o))).then(boot);

    // Expose current UI selection for the PDF generator
    window.PP_VIEW = {
      getSelection: () => ({
        region: document.getElementById('pp-region')?.value || 'scotland',
        category: document.getElementById('pp-category')?.value || 'all',
        q: (document.getElementById('pp-search')?.value || '').trim(),
        monthOnly: !!document.getElementById('pp-this-month')?.checked
      })
    };
  </script>

  <!-- ===== PDF libs via CDN (per your instruction) ===== -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- PDF generator (local) -->
  <script src="assets/pdf/pdf-generator.js?v=pp-final"></script>

  <!-- Wire the button (iOS-friendly) -->
  <script>
    (function(){
      const btn=document.getElementById('pp-make-pdf');
      if(!btn) return;
      btn.addEventListener('click', async ()=>{
        try{
          btn.disabled=true; btn.textContent='Buildingâ€¦';
          if(!window.PP_PDF || !window.PP_PDF.generate){ alert('PDF generator not found.'); return; }
          await window.PP_PDF.generate(window.PP_VIEW.getSelection());
        }catch(err){
          alert('PDF build failed.');
        }finally{
          btn.disabled=false; btn.textContent='ðŸ“„ Download PDF';
        }
      });
    })();
  </script>
</body>
</html>
